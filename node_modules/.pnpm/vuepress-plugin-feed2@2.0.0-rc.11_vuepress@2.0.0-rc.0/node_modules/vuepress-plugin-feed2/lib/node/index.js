import{fs as d,getDirname as J,path as T,colors as O}from"@vuepress/utils";import{createConverter as K,isPlainObject as D,fromEntries as U,entries as F,encodeXMLContent as C,encodeCDATA as q,isArray as f,Logger as V,isLinkHttp as y,removeEndingSlash as v,removeLeadingSlash as $,isUrl as E,isAbsoluteUrl as N,HTML_TAGS as z,SVG_TAGS as B,MATHML_TAGS as Q,isFunction as h,getPageText as W,getAuthor as X,getCategory as Y,getPageExcerpt as Z,ensureEndingSlash as tt,values as et,keys as L,compareDate as it,deepAssign as st,checkVersion as at}from"vuepress-shared/node";import{js2xml as P}from"xml-js";import{load as rt}from"cheerio";const nt=e=>{const{deprecatedLogger:t,droppedLogger:s}=K("feed2"),i=e.output;D(i)&&(e.atom=i.atom?.enable??!1,e.json=i.json?.enable??!1,e.rss=i.rss?.enable??!1,e.atomOutputFilename=i.atom?.path??"atom.xml",e.jsonOutputFilename=i.json?.path??"feed.json",e.rssOutputFilename=i.rss?.path??"rss.xml"),t({options:e,old:"customElements",new:"preservedElements"}),t({options:e,old:"removedElements",new:"preservedElements"}),s({options:e,old:"output"})},A=e=>U(F(e).map(([t,s])=>t==="_attributes"&&s?[t,U(F(s).map(([i,r])=>[i,r?C(r.toString()):void 0]))]:t==="_text"?[t,C(s.toString())]:t==="_cdata"?[t,q(s)]:t==="_comment"||t==="_instruction"?[t,s]:f(s)?[t,s.map(i=>A(i))]:D(s)?[t,A(s)]:[t,C(String(s))])),w="vuepress-plugin-feed2",_=new V(w),p=(e,t="",s="")=>`${y(e)?v(e):`https://${v(e)}`}${t}${$(s)}`,ot=(e="")=>`image/${e==="jpg"?"jpeg":e==="svg"?"svg+xml":e==="jpeg"||e==="png"||e==="bmp"||e==="gif"||e==="webp"?e:""}`,j=e=>{const{name:t="Unknown",email:s,url:i}=e;return{name:t,...s?{email:s}:{},...i?{uri:i}:{}}},lt=e=>{const{name:t,scheme:s=""}=e;return{_attributes:{term:t,scheme:s}}},pt=e=>{const{channel:t,links:s}=e.options,i={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${s.atomXsl}"`},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:f(t.author)?t.author.map(r=>j(r)):[j(t.author)]}:{},...t.icon?{icon:t.icon}:{},...t.image?{logo:t.image}:{},...t.copyright?{rights:t.copyright}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:w,link:[{_attributes:{rel:"self",href:s.atom}}]}};return t.link&&i.feed.link.push({_attributes:{rel:"alternate",href:t.link}}),t.hub&&i.feed.link.push({_attributes:{rel:"hub",href:t.hub}}),t.image&&(i.feed.logo=t.image),t.icon&&(i.feed.icon=t.icon),t.copyright&&(i.feed.rights=t.copyright),i.feed.category=Array.from(e.categories).map(r=>({_attributes:{term:r}})),i.feed.contributor=Array.from(e.contributors).filter(r=>r.name).map(r=>j(r)),i.feed.entry=e.items.map(r=>{const a={title:{_attributes:{type:"text"},_text:r.title},id:r.guid||r.link,link:{_attributes:{href:r.link}},updated:r.lastUpdated.toISOString()};return r.summary?a.summary={_attributes:{type:"html"},_cdata:r.summary}:r.description&&(a.summary={_attributes:{type:"text"},_text:r.description}),r.content&&(a.content={_attributes:{type:"html"},_cdata:r.content}),r.author&&(a.author=r.author.filter(n=>n.name).map(n=>j(n))),r.category&&(a.category=r.category.map(n=>lt(n))),r.contributor&&(a.contributor=r.contributor.map(n=>j(n))),r.pubDate&&(a.published=r.pubDate.toISOString()),r.copyright&&(a.rights=r.copyright),a}),P(A(i),{compact:!0,ignoreComment:!0,spaces:2})},I=e=>({name:e.name,...e.url?{url:e.url}:{},...e.avatar?{avatar:e.avatar}:{}}),ct=e=>{const{channel:t,links:s}=e.options,i={version:"https://jsonfeed.org/version/1.1",title:t.title,home_page_url:t.link,feed_url:s.json};t.description&&(i.description=t.description),t.image&&(i.icon=t.image),t.icon&&(i.favicon=t.icon);const r=(f(t.author)?t.author:t.author?[t.author]:[]).filter(a=>!!a?.name);return r.length&&(i.authors=r.map(a=>I(a))),i.items=e.items.map(a=>{const n={title:a.title,url:a.link,id:a.guid||a.link,...a.description?{summary:a.description}:{},content_html:a.content};return a.image&&(n.image=a.image),a.pubDate&&(n.date_published=a.pubDate.toISOString()),a.lastUpdated&&(n.date_modified=a.lastUpdated.toISOString()),f(a.author)&&(n.authors=a.author.filter(o=>o.name).map(o=>I(o))),a.category&&(n.tags=a.category.filter(o=>o.name).map(o=>o.name)),n}),JSON.stringify(i,null,2)},mt=e=>{const{name:t,domain:s}=e;return{_text:t,...s?{_attributes:{domain:s}}:{}}},ht=e=>{const t=e.guid||e.link;return{...E(t)?{}:{_attributes:{isPermaLink:"false"}},_text:t}},ut=e=>({_attributes:{url:e.url,...e.length?{length:e.length}:{},...e.type?{type:e.type}:{}}}),gt=e=>{const{links:t,channel:s}=e.options;let i=!1;const r={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${t.rssXsl}"`},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:s.title},link:{_text:s.link},description:{_text:s.description},language:{_text:s.language},pubDate:{_text:s.pubDate?s.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:s.lastUpdated?s.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:w},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return s.copyright&&(r.rss.channel.copyright={_text:s.copyright}),s.ttl&&(r.rss.channel.ttl={_text:s.ttl.toString()}),s.image&&(r.rss.channel.image={title:{_text:s.title},url:{_text:s.image},link:{_text:s.link}}),r.rss.channel.category=Array.from(e.categories).map(a=>({_text:a})),r.rss.channel.item=e.items.map(a=>{const n={title:{_text:a.title},link:{_text:a.link},guid:ht(a),source:{_attributes:{url:t.rss},_text:a.title}};if(a.description&&(n.description={_text:a.description}),a.author){const o=a.author.find(l=>l.email&&l.name);o&&(n.author={_text:`${o.email} (${o.name})`})}return a.category&&(n.category=a.category.filter(o=>o.name).map(o=>mt(o))),a.comments&&(n.comments={_text:a.link}),a.pubDate&&(n.pubDate={_text:a.pubDate.toUTCString()}),a.content&&(i=!0,n["content:encoded"]={_cdata:a.content}),a.enclosure&&(n.enclosure=ut(a.enclosure)),n}),i&&(r.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",r.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),P(A(r),{compact:!0,ignoreComment:!0,spaces:2})};class dt{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=s=>{this.items.push(s)},this.addCategory=s=>{this.categories.add(s)},this.addContributor=s=>{const i=s.email||s.name;i&&!this._contributorKeys.has(i)&&(this._contributorKeys.add(i),this.contributors.push(s))},this.atom=()=>pt(this),this.rss=()=>gt(this),this.json=()=>ct(this)}}const ft=["h1","h2","h3","h4","h5","h6"],M=(e,t,s)=>{if(e.type==="tag"){if(e.tagName==="img"){const{src:i}=e.attribs;if(!y(i)&&!N(i))return null}return[e.attribs.class,e.attribs.id].some(i=>["table-of-contents","toc"].includes(i))||e.tagName==="pre"?null:z.includes(e.tagName)||B.includes(e.tagName)||Q.includes(e.tagName)?(ft.includes(e.tagName)&&(delete e.attribs.id,delete e.attribs.tabindex,e.children=e.children.filter(i=>i.type!=="tag"||i.tagName!=="a"||i.attribs.class!=="header-anchor")),e.tagName==="code"&&delete e.attribs["v-pre"],e.children=R(e.children,t,s),e):e.tagName==="routerlink"||e.tagName==="vplink"?(e.tagName="a",e.attribs.href=`${v(t)}${e.attribs.to}`,e.attribs.target="blank",delete e.attribs.to,e.children=R(e.children,t,s),e):s(e.tagName)?e:null}return e},R=(e,t,s)=>f(e)?e.map(i=>M(i,t,s)).filter(i=>i!==null):[],G=rt(""),bt=(e,t,s)=>{const i=e.dir.dest(t.path),r=d.existsSync(i)?d.readFileSync(i,"utf-8"):t.contentRendered;let a="";const n=G.parseHTML(r)||[];for(const o of n){const l=M(o,e.options.base,s);l&&(a+=`${G.html(l)}`)}return a};class yt{constructor(t,s,i,r){this.app=t,this.options=s,this.page=i,this.feed=r,this.base=this.app.options.base,this.frontmatter=i.frontmatter,this.getter=s.getter||{},this.pageOptions=this.frontmatter.feed||{},this.isPreservedElement=a=>{const{preservedElements:n}=this.options;return f(n)?n.some(o=>o instanceof RegExp?o.test(a):o===a):h(n)?n(a):!1}}get title(){return h(this.getter.title)?this.getter.title(this.page):this.pageOptions.title||this.page.title}get link(){return h(this.getter.link)?this.getter.link(this.page):p(this.options.hostname,this.base,this.page.path)}get description(){if(h(this.getter.description))return this.getter.description(this.page);if(this.pageOptions.description)return this.pageOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=W(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){return h(this.getter.author)?this.getter.author(this.page):f(this.pageOptions.author)?this.pageOptions.author:D(this.pageOptions.author)?[this.pageOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?X(this.frontmatter.author):this.options.channel?.author?X(this.options.channel?.author):[]}get category(){if(h(this.getter.category))return this.getter.category(this.page);if(f(this.pageOptions.category))return this.pageOptions.category;if(D(this.pageOptions.category))return[this.pageOptions.category];const{categories:t,category:s=t}=this.frontmatter;return Y(s).map(i=>({name:i}))}get enclosure(){return h(this.getter.enclosure)?this.getter.enclosure(this.page):this.image?{url:this.image,type:ot(this.image.split(".").pop())}:null}get guid(){return this.pageOptions.guid||this.link}get pubDate(){if(h(this.getter.publishDate))return this.getter.publishDate(this.page);const{time:t,date:s=t}=this.page.frontmatter,{createdTime:i}=this.page.data.git||{};return s&&s instanceof Date?s:i?new Date(i):null}get lastUpdated(){if(h(this.getter.lastUpdateDate))return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get excerpt(){return h(this.getter.excerpt)?this.getter.excerpt(this.page):this.pageOptions.summary?this.pageOptions.summary:Z(this.app,this.page,{isCustomElement:this.isPreservedElement})}get content(){return h(this.getter.content)?this.getter.content(this.page):this.pageOptions.content?this.pageOptions.content:bt(this.app,this.page,this.isPreservedElement)}get image(){if(h(this.getter.image))return this.getter.image(this.page);const{banner:t,cover:s}=this.frontmatter;if(t){if(N(t))return p(this.options.hostname,this.app.options.base,t);if(E(t))return t}if(s){if(N(s))return p(this.options.hostname,this.app.options.base,s);if(E(s))return s}const i=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(i){if(N(i[1]))return p(this.options.hostname,this.app.options.base,i[1]);if(E(i[1]))return i[1]}return null}get contributor(){return h(this.getter.contributor)?this.getter.contributor(this.page):f(this.pageOptions.contributor)?this.pageOptions.contributor:D(this.pageOptions.contributor)?[this.pageOptions.contributor]:this.author}get copyright(){if(h(this.getter.copyright))return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t?.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:s,content:i,contributor:r,copyright:a,description:n,enclosure:o,excerpt:l,guid:c,image:m,lastUpdated:u,link:g,pubDate:b,title:x}=this;return!x&&!n?null:(s&&s.forEach(S=>this.feed.addCategory(S.name)),r&&r.forEach(S=>this.feed.addContributor(S)),{title:x,link:g,guid:c,lastUpdated:u,content:i,author:t,contributor:r,...n?{description:n}:{},...l?{summary:l}:{},...s?{category:s}:{},...o?{enclosure:o}:{},...b?{pubDate:b}:{},...m?{image:m}:{},...a?{copyright:a}:{}})}}const _t=J(import.meta.url),H=tt(T.resolve(_t,"../../templates")),xt=e=>e.hostname?(e.hostname=y(e.hostname)?v(e.hostname):`https://${v(e.hostname)}`,!0):!1,Ot=e=>e.locales&&et(e.locales).some(({atom:t,json:s,rss:i})=>t||s||i)||!!(e.atom||e.json||e.rss),Ft=({siteData:e},t)=>U(L({"/":{},...e.locales}).map(s=>[s,{filter:({frontmatter:i,filePathRelative:r})=>!(i.home||!r||i.article===!1||i.feed===!1),sorter:(i,r)=>it(i.data.git?.createdTime?new Date(i.data.git?.createdTime):i.frontmatter.date,r.data.git?.createdTime?new Date(r.data.git?.createdTime):r.frontmatter.date),...t,...t.locales?.[s],hostname:t.hostname}])),$t=(e,t,s="")=>{const{base:i}=e.options,{title:r,description:a,lang:n,locales:o}=e.siteData,{channel:l={},hostname:c,icon:m,image:u}=t,g=f(t.channel?.author)?t.channel?.author[0]?.name:t.channel?.author?.name,b={title:o[s]?.title||r||o["/"]?.title||"",link:p(c,i,s),description:o[s]?.description||a||o["/"]?.description||"",language:o[s]?.lang||n,copyright:g?`Copyright by ${g}`:"",pubDate:new Date,lastUpdated:new Date,...m?{icon:y(m)?m:p(c,i,m)}:{},...u?{image:y(u)?u:p(c,i,u)}:{}};return st(b,l,{...l.icon?{icon:y(l.icon)?l.icon:p(c,i,l.icon)}:{},...l.image?{image:y(l.image)?l.image:p(c,i,l.image)}:{}})},k=(e,t="/")=>({atomOutputFilename:`${$(t)}${e.atomOutputFilename||"atom.xml"}`,atomXslFilename:`${$(t)}${e.atomXslFilename||"atom.xsl"}`,atomXslTemplate:e.atomXslTemplate||`${H}atom.xsl`,jsonOutputFilename:`${$(t)}${e.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${$(t)}${e.rssOutputFilename||"rss.xml"}`,rssXslFilename:`${$(t)}${e.rssXslFilename||"rss.xsl"}`,rssXslTemplate:e.rssXslTemplate||`${H}rss.xsl`}),kt=({options:{base:e}},t,s)=>{const{hostname:i}=t,{atomOutputFilename:r,atomXslFilename:a,jsonOutputFilename:n,rssOutputFilename:o,rssXslFilename:l}=k(t,s);return{localePath:s,atom:p(i,e,r),atomXsl:p(i,e,a),json:p(i,e,n),rss:p(i,e,o),rssXsl:p(i,e,l)}};class St{constructor(t,s){this.app=t,this.options=s,this.feedMap=U(F(s).map(([i,r])=>[i,new dt({channel:$t(t,r,i),links:kt(t,r,i)})]))}addPages(t){const s=this.feedMap[t],i=this.options[t],{count:r=100,filter:a,sorter:n}=i,o=this.app.pages.filter(c=>c.pathLocale===t).filter(a).sort(n).slice(0,r);let l=0;for(const c of o){const m=new yt(this.app,i,c,s).getFeedItem();m&&(s.addItem(m),l+=1)}_.succeed(`added ${O.cyan(`${l} page${l>1?"s":""}`)} as feed item${l>1?"s":""} in route ${O.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all([...F(this.options).map(async([s,i])=>{if(i.atom||i.json||i.rss){const r=this.feedMap[s],{atomOutputFilename:a,jsonOutputFilename:n,rssOutputFilename:o}=k(i,s);this.addPages(s),i.atom&&(await d.ensureDir(T.dirname(t(a))),await d.outputFile(t(a),r.atom()),_.succeed(`Atom feed file generated and saved to ${O.cyan(`/${a}`)}`)),i.json&&(await d.ensureDir(T.dirname(t(n))),await d.outputFile(t(n),r.json()),_.succeed(`JSON feed file generated and saved to ${O.cyan(`/${n}`)}`)),i.rss&&(await d.ensureDir(T.dirname(t(o))),await d.outputFile(t(o),r.rss()),_.succeed(`RSS feed file generated and saved to ${O.cyan(`/${o}`)}`))}}),F(this.options).filter(([,{atom:s}])=>s).map(([s,i])=>{const{atomXslTemplate:r,atomXslFilename:a}=k(i,s);return d.copyFile(r,t(a))}),F(this.options).filter(([,{rss:s}])=>s).map(([s,i])=>{const{rssXslFilename:r,rssXslTemplate:a}=k(i,s);return d.copyFile(a,t(r))})])}}const Dt=(e,t)=>{const{base:s}=e.options,{siteData:i}=e,r=L(t);if(r.length===1){const{atomOutputFilename:a,jsonOutputFilename:n,rssOutputFilename:o}=k(t["/"]),{atom:l,json:c,rss:m,hostname:u}=t["/"],g=(b,x,S)=>["link",{rel:"alternate",type:S,href:p(u,s,x),title:`${i.title||i.locales["/"]?.title||""} ${b} Feed`}];i.head??=[],l&&i.head.push(g("Atom",a,"application/atom+xml")),c&&i.head.push(g("JSON",n,"application/json")),m&&i.head.push(g("RSS",o,"application/rss+xml"))}else e.pages.forEach(a=>{const{pathLocale:n}=a,o=t[n];if(r.includes(n)){const{atomOutputFilename:l,jsonOutputFilename:c,rssOutputFilename:m}=k(o,n),u=(g,b,x)=>["link",{rel:"alternate",type:x,href:p(o.hostname,s,b),title:`${i.locales[n]?.title||i.title||i.locales["/"]?.title||""} ${g} Feed`}];a.frontmatter.head??=[],o.atom&&a.frontmatter.head.push(u("Atom",l,"application/atom+xml")),o.json&&a.frontmatter.head.push(u("JSON",c,"application/json")),o.rss&&a.frontmatter.head.push(u("RSS",m,"application/rss+xml"))}})},vt=(e,t=!0)=>s=>{t&&nt(e),at(s,w,"2.0.0-rc.0"),s.env.isDebug&&_.info("Options:",e);const i={name:w};if(!xt(e))return _.error(`Option ${O.magenta("hostname")} is required!`),i;if(!Ot(e))return _.info("No requested output, the plugin wonâ€™t start!"),i;const r=Ft(s,e);return{...i,onInitialized:a=>Dt(a,r),onGenerated:a=>new St(a,r).generateFeed()}};export{vt as feedPlugin};
//# sourceMappingURL=index.js.map
